<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Proyecto 1 - Sistema M/M/1</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
<div class="layout">
    <header>
        <div>
            <div class="title">Proyecto 1: Sistema M/M/1</div>
            <div class="subtitle">
                Servidor Flask, cliente Poisson, simulaci√≥n y an√°lisis de tr√°fico real (Wireshark).
            </div>
        </div>
        <div class="badge">Procesos Estoc√°sticos</div>
    </header>

    <div class="grid">
        <!-- Columna izquierda -->
        <div class="card">
            <h2>Control del experimento</h2>
            <p class="subtitle" style="margin-top: 2px;">
                Inicia servidor y cliente, ajusta par√°metros (Œª, Œº, n) y analiza resultados.
            </p>

            <div class="controls">
                <button class="btn btn-primary" id="btn-server">
                    üñ•Ô∏è Iniciar servidor
                </button>
                <button class="btn btn-primary" id="btn-client">
                    üì° Iniciar cliente
                </button>
                <button class="btn btn-secondary" onclick="window.location.reload()">
                    üîÑ Actualizar m√©tricas
                </button>
            </div>

            <div id="status" class="status"></div>

            {% if not data_available %}
            <div class="alert">
                <strong>Sin datos todav√≠a.</strong> Inicia el servidor y luego el cliente para generar los CSV en la carpeta
                <code>file/</code>. Despu√©s presiona <em>Actualizar m√©tricas</em>.
            </div>
            {% endif %}

            {% if data_available and metricas %}
            <h3>Par√°metros te√≥ricos / simulaci√≥n</h3>
            <form method="get" action="{{ url_for('mm1_dashboard') }}" style="margin-top:8px;">
                <table class="metrics-table">
                    <tr>
                        <th>Par√°metro</th><th>Valor</th>
                    </tr>
                    <tr>
                        <td>Œª (para teor√≠a/simulaci√≥n)</td>
                        <td>
                            <input type="number" step="0.0001" name="lambda_teo"
                                   value="{{ lambda_teo|round(4) }}" style="width:100%;">
                        </td>
                    </tr>
                    <tr>
                        <td>Œº (para teor√≠a/simulaci√≥n)</td>
                        <td>
                            <input type="number" step="0.0001" name="mu_teo"
                                   value="{{ mu_teo|round(4) }}" style="width:100%;">
                        </td>
                    </tr>
                    <tr>
                        <td>n clientes (simulaci√≥n)</td>
                        <td>
                            <input type="number" name="n_sim" value="{{ n_sim }}" style="width:100%;">
                        </td>
                    </tr>
                </table>
                <div style="margin-top:8px;">
                    <button class="btn btn-secondary" type="submit">Aplicar par√°metros</button>
                </div>
            </form>

            <h3>M√©tricas principales</h3>

            <div class="metrics-badges">
                <div class="metric-pill">
                    <span>ŒªÃÇ (server):</span> {{ metricas.lambda_hat_server|round(4) }}
                </div>
                <div class="metric-pill">
                    <span>ŒªÃÇ (cliente):</span> {{ metricas.lambda_hat_client|round(4) }}
                </div>
                <div class="metric-pill">
                    <span>ŒºÃÇ:</span> {{ metricas.mu_hat|round(4) }}
                </div>
                <div class="metric-pill">
                    <span>œÅÃÇ:</span> {{ metricas.rho_hat|round(4) }}
                </div>
                {% if wireshark_stats %}
                <div class="metric-pill">
                    <span>ŒªÃÇ (Wireshark):</span> {{ wireshark_stats.lambda_wireshark|round(4) }}
                </div>
                {% endif %}
            </div>

            <table class="metrics-table">
                <tr><th>M√©trica</th><th>Emp√≠rico</th><th>Te√≥rico</th><th>Simulaci√≥n</th></tr>
                <tr>
                    <td>Wq (espera en cola)</td>
                    <td>{{ metricas.Wq_emp|round(4) }}</td>
                    <td>{{ metricas.Wq_teo|round(4) }}</td>
                    <td>{{ sim_results.Wq_sim|round(4) }}</td>
                </tr>
                <tr>
                    <td>W (tiempo en sistema)</td>
                    <td>{{ metricas.W_emp|round(4) }}</td>
                    <td>{{ metricas.W_teo|round(4) }}</td>
                    <td>{{ sim_results.W_sim|round(4) }}</td>
                </tr>
                <tr>
                    <td>Lq (n¬∞ en cola)</td>
                    <td>{{ metricas.Lq_emp|round(4) }}</td>
                    <td>{{ metricas.Lq_teo|round(4) }}</td>
                    <td>{{ sim_results.Lq_sim|round(4) }}</td>
                </tr>
                <tr>
                    <td>L (n¬∞ en sistema)</td>
                    <td>{{ metricas.L_emp|round(4) }}</td>
                    <td>{{ metricas.L_teo|round(4) }}</td>
                    <td>{{ sim_results.L_sim|round(4) }}</td>
                </tr>
            </table>

            <div style="margin-top:10px;">
                <button class="btn btn-primary" id="btn-save-exp">üíæ Guardar experimento</button>
                <a class="btn btn-secondary" href="{{ url_for('export_experiments') }}" target="_blank">
                    ‚¨áÔ∏è Exportar historial
                </a>
            </div>

            <div id="current-metrics"
                 data-lambda-server="{{ metricas.lambda_hat_server }}"
                 data-lambda-client="{{ metricas.lambda_hat_client }}"
                 data-mu-hat="{{ metricas.mu_hat }}"
                 data-rho-hat="{{ metricas.rho_hat }}"
                 data-wq-emp="{{ metricas.Wq_emp }}"
                 data-w-emp="{{ metricas.W_emp }}"
                 data-lq-emp="{{ metricas.Lq_emp }}"
                 data-l-emp="{{ metricas.L_emp }}"
                 data-wq-teo="{{ metricas.Wq_teo }}"
                 data-w-teo="{{ metricas.W_teo }}"
                 data-lq-teo="{{ metricas.Lq_teo }}"
                 data-l-teo="{{ metricas.L_teo }}"
                 data-wq-sim="{{ sim_results.Wq_sim }}"
                 data-w-sim="{{ sim_results.W_sim }}"
                 data-lq-sim="{{ sim_results.Lq_sim }}"
                 data-l-sim="{{ sim_results.L_sim }}"
                 data-lambda-teo="{{ lambda_teo }}"
                 data-mu-teo="{{ mu_teo }}"
                 data-n-sim="{{ n_sim }}"
                 {% if wireshark_stats %}
                 data-lambda-w="{{ wireshark_stats.lambda_wireshark }}"
                 {% endif %}>
            </div>

            {% if experiments %}
            <h3 style="margin-top:16px;">Historial (√∫ltimos {{ experiments|length }})</h3>
            <table class="metrics-table">
                <tr>
                    <th>Fecha</th>
                    <th>Œª_teo</th>
                    <th>Œº_teo</th>
                    <th>Wq_emp</th>
                    <th>Wq_teo</th>
                    <th>Wq_sim</th>
                </tr>
                {% for e in experiments %}
                <tr>
                    <td>{{ e.timestamp }}</td>
                    <td>{{ "%.4f"|format(e.lambda_teo) }}</td>
                    <td>{{ "%.4f"|format(e.mu_teo) }}</td>
                    <td>{{ "%.4f"|format(e.Wq_emp) }}</td>
                    <td>{{ "%.4f"|format(e.Wq_teo) }}</td>
                    <td>{{ "%.4f"|format(e.Wq_sim) }}</td>
                </tr>
                {% endfor %}
            </table>
            {% endif %}
            {% endif %}
        </div>

        <!-- Columna derecha: carrusel de gr√°ficas PNG -->
        <div class="card">
            <h2>Gr√°ficas del sistema</h2>

            {% if data_available and plot_files %}
            <div class="carousel-wrapper">
                <div class="carousel" id="mm1-carousel">
                    <button class="carousel-btn prev" id="carousel-prev" type="button">‚Äπ</button>
                    <button class="carousel-btn next" id="carousel-next" type="button">‚Ä∫</button>
                    <img id="carousel-image" class="carousel-image"
                         src="" alt="Gr√°fica del sistema">
                    <div class="carousel-caption" id="carousel-caption"></div>
                </div>
                <div class="carousel-dots" id="carousel-dots"></div>
            </div>
            {% else %}
            <div class="alert">
                No hay gr√°ficas todav√≠a. Genera datos con el servidor y el cliente, luego actualiza esta vista.
            </div>
            {% endif %}
        </div>
    </div>
</div>

{# Pasamos la lista de im√°genes al JS #}
{% if data_available and plot_files %}
<script>
    window.MM1_HAS_PLOTS = true;
    window.MM1_PLOTS_BASE = "{{ url_for('static', filename='plots/') }}";
    window.MM1_PLOTS = {{ plot_files|tojson|safe }};
</script>
{% else %}
<script>
    window.MM1_HAS_PLOTS = false;
</script>
{% endif %}

<script src="{{ url_for('static', filename='js/mm1.js') }}"></script>
</body>
</html>
